#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "usage: promptpad-editor [--line N] [--column N] <file>" >&2
  exit 2
fi

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd -- "$script_dir/.." && pwd)"
local_promptpad="$repo_root/.build/release/promptpad"
local_promptpad_open="$repo_root/.build/release/promptpad-open"
file=""
line=""
column=""

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --line)
        [[ $# -ge 2 ]] || { echo "promptpad-editor: missing value for --line" >&2; exit 2; }
        line="$2"
        shift 2
        ;;
      --column)
        [[ $# -ge 2 ]] || { echo "promptpad-editor: missing value for --column" >&2; exit 2; }
        column="$2"
        shift 2
        ;;
      +[0-9]*)
        line="${1#+}"
        shift
        ;;
      --)
        shift
        if [[ $# -gt 0 ]]; then
          file="$1"
          shift
        fi
        ;;
      -*)
        shift
        ;;
      *)
        file="$1"
        shift
        ;;
    esac
  done
}

parse_args "$@"

if [[ -z "$file" ]]; then
  echo "promptpad-editor: missing file argument" >&2
  exit 2
fi

detect_terminal_bundle_id() {
  if [[ -n "${PROMPTPAD_TERMINAL_BUNDLE_ID:-}" ]]; then
    printf '%s\n' "$PROMPTPAD_TERMINAL_BUNDLE_ID"
    return 0
  fi
  case "${TERM_PROGRAM:-}" in
    Apple_Terminal) printf '%s\n' "com.apple.Terminal" ;;
    iTerm.app) printf '%s\n' "com.googlecode.iterm2" ;;
    WezTerm) printf '%s\n' "com.github.wez.wezterm" ;;
    ghostty|Ghostty) printf '%s\n' "com.mitchellh.ghostty" ;;
    *) return 1 ;;
  esac
}

previous_frontmost_app=""
if command -v osascript >/dev/null 2>&1; then
  previous_frontmost_app="$(osascript -e 'tell application "System Events" to get bundle identifier of first process whose frontmost is true' 2>/dev/null || true)"
fi

run_editor() {
  # Large timeout so long editing sessions don't fail Ctrl+G unexpectedly.
  local timeout_ms="86400000"
  local open_args=(--path "$file" --wait --timeout-ms "$timeout_ms")
  if [[ -n "$line" ]]; then
    open_args+=(--line "$line")
  fi
  if [[ -n "$column" ]]; then
    open_args+=(--column "$column")
  fi

  local prefer_fast="${PROMPTPAD_EDITOR_MODE:-}"

  if [[ "$prefer_fast" == "fast" ]] && [[ -x "$local_promptpad_open" ]]; then
    "$local_promptpad_open" "${open_args[@]}"
    return $?
  fi

  if [[ -x "$local_promptpad" ]]; then
    "$local_promptpad" open "${open_args[@]}"
    return $?
  fi

  if [[ "$prefer_fast" == "fast" ]] && command -v promptpad-open >/dev/null 2>&1; then
    promptpad-open "${open_args[@]}"
    return $?
  fi

  if command -v promptpad >/dev/null 2>&1; then
    promptpad open "${open_args[@]}"
    return $?
  fi

  if [[ -x "$local_promptpad_open" ]]; then
    "$local_promptpad_open" "${open_args[@]}"
    return $?
  fi

  if command -v promptpad-open >/dev/null 2>&1; then
    promptpad-open "${open_args[@]}"
    return $?
  fi

  echo "promptpad editor hook not available (need promptpad or promptpad-open in PATH)" >&2
  return 127
}

rc=0
if ! run_editor; then
  rc=$?
fi

# Restore focus to the terminal app after editor closes.
if command -v osascript >/dev/null 2>&1; then
  if terminal_bundle_id="$(detect_terminal_bundle_id)"; then
    osascript -e "tell application id \"$terminal_bundle_id\" to activate" >/dev/null 2>&1 || true
  elif [[ -n "$previous_frontmost_app" ]]; then
    osascript -e "tell application id \"$previous_frontmost_app\" to activate" >/dev/null 2>&1 || true
  fi
fi

exit $rc
