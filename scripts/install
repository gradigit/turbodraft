#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd -- "$script_dir/.." && pwd)"
bin_dir="${TURBODRAFT_BIN_DIR:-$HOME/.local/bin}"

# ── Build ────────────────────────────────────────────────────────────────────

echo "Building release..."
(cd "$repo_root" && swift build -c release)
echo "Build complete."

# ── Symlink binaries ────────────────────────────────────────────────────────

mkdir -p "$bin_dir"

link() {
  local name="$1"
  local src="$repo_root/.build/release/$name"
  local dst="$bin_dir/$name"
  if [[ ! -x "$src" ]]; then
    echo "  skip $name (not built)"
    return
  fi
  ln -sf "$src" "$dst"
  echo "  $dst -> $src"
}

echo "Linking binaries to $bin_dir:"
link turbodraft
link turbodraft-app
link turbodraft-open

# Link the editor shim script too.
ln -sf "$repo_root/scripts/turbodraft-editor" "$bin_dir/turbodraft-editor"
echo "  $bin_dir/turbodraft-editor -> $repo_root/scripts/turbodraft-editor"

# ── Restart Launch Agent if installed ───────────────────────────────────────

label="${TURBODRAFT_LAUNCH_AGENT_LABEL:-com.turbodraft.app}"
plist_path="${HOME}/Library/LaunchAgents/${label}.plist"
uid="$(id -u)"

if [[ -f "$plist_path" ]]; then
  echo "Restarting LaunchAgent..."
  launchctl kickstart -k "gui/${uid}/${label}" 2>/dev/null && echo "  Restarted." || echo "  Restart failed (may need: scripts/turbodraft-launch-agent install)"
else
  echo ""
  echo "LaunchAgent not installed. For warm-start mode (recommended):"
  echo "  scripts/turbodraft-launch-agent install"
fi

# ── Verify ──────────────────────────────────────────────────────────────────

echo ""
if command -v turbodraft >/dev/null 2>&1; then
  echo "Done. turbodraft is on your PATH."
else
  echo "Done. Add $bin_dir to your PATH:"
  echo "  fish:  fish_add_path $bin_dir"
  echo "  bash:  echo 'export PATH=\"$bin_dir:\$PATH\"' >> ~/.bashrc"
  echo "  zsh:   echo 'export PATH=\"$bin_dir:\$PATH\"' >> ~/.zshrc"
fi
