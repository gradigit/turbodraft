#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd -- "$script_dir/.." && pwd)"
bin_dir="${TURBODRAFT_BIN_DIR:-$HOME/.local/bin}"

# ── Build ────────────────────────────────────────────────────────────────────

echo "Building release..."
(cd "$repo_root" && swift build -c release)
echo "Build complete."

# ── Symlink binaries ────────────────────────────────────────────────────────

mkdir -p "$bin_dir"

link() {
  local name="$1"
  local src="$repo_root/.build/release/$name"
  local dst="$bin_dir/$name"
  if [[ ! -x "$src" ]]; then
    echo "  skip $name (not built)"
    return
  fi
  ln -sf "$src" "$dst"
  echo "  $dst -> $src"
}

echo "Linking binaries to $bin_dir:"
link turbodraft
link turbodraft-app
link turbodraft-bench

# ── Clean up old binary names ─────────────────────────────────────────────

for old_name in turbodraft-open turbodraft-editor; do
  old_link="$bin_dir/$old_name"
  if [[ -L "$old_link" || -e "$old_link" ]]; then
    rm -f "$old_link"
    echo "  removed stale $old_link"
  fi
done

# ── Restart Launch Agent if installed ───────────────────────────────────────

label="${TURBODRAFT_LAUNCH_AGENT_LABEL:-com.turbodraft.app}"
plist_path="${HOME}/Library/LaunchAgents/${label}.plist"
uid="$(id -u)"

if [[ -f "$plist_path" ]]; then
  echo "Restarting LaunchAgent..."
  launchctl kickstart -k "gui/${uid}/${label}" 2>/dev/null && echo "  Restarted." || echo "  Restart failed (may need: scripts/turbodraft-launch-agent install)"
else
  echo ""
  echo "LaunchAgent not installed. For warm-start mode (recommended):"
  echo "  scripts/turbodraft-launch-agent install"
fi

# ── Verify ──────────────────────────────────────────────────────────────────

echo ""
if command -v turbodraft >/dev/null 2>&1; then
  echo "Done. turbodraft is on your PATH."
  echo ""
  echo "Set as your editor:"
  echo "  fish:  set -Ux VISUAL turbodraft"
  echo "  bash:  export VISUAL=turbodraft"
  echo "  zsh:   export VISUAL=turbodraft"
else
  echo "Done. Add $bin_dir to your PATH:"
  echo "  fish:  fish_add_path $bin_dir"
  echo "  bash:  echo 'export PATH=\"$bin_dir:\$PATH\"' >> ~/.bashrc"
  echo "  zsh:   echo 'export PATH=\"$bin_dir:\$PATH\"' >> ~/.zshrc"
fi
